# .github/workflows/ci-security.yml
name: CI Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read # for actions/checkout
  security-events: write # for github/codeql-action/upload-sarif
  actions: read # for slackapi/slack-github-action

jobs:
  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Phase 2: 코드 레벨 분석 ---

      # 1. SCA: Python 의존성 분석 (pip-audit)
      - name: Install and run pip-audit
        run: |
          pip install pip-audit
          pip-audit

      # 2. SAST: Semgrep 스캔 (고속)
      - name: Run Semgrep SAST Scan
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" semgrep/semgrep:latest semgrep scan --sarif --output /src/semgrep-results.sarif --config p/default
      - name: Upload Semgrep SARIF results to GitHub Security Dashboard
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep-results.sarif
          if: always() # 스캔 실패 시에도 SARIF 파일 업로드

      # 3. SAST: CodeQL 분석 (심층) - 초기화
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: "go, javascript, python" # 분석할 언어 지정

      # (여기에 빌드 및 테스트 스텝이 위치합니다)
      # - name: Build project...
      # - name: Run tests...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      # --- Phase 3: 아티팩트 보안 검증 ---

      # 4. Docker 이미지 빌드 (예시)
      - name: Build Docker image
        run: |
          docker build -t my-app:${{ github.sha }} .

      # 5. Container Scanning: Trivy 스캔
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "my-app:${{ github.sha }}"
          format: "table"
          # Critical, High 등급의 취약점이 발견되면 워크플로우 실패 처리
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  check-notification-status:
    runs-on: ubuntu-latest
    outputs:
      enable_slack: ${{ steps.check.outputs.enable_slack }}
      enable_discord: ${{ steps.check.outputs.enable_discord }}
    steps:
      - name: Check if notification secrets are configured
        id: check
        run: |
          echo "enable_slack=${{ secrets.SLACK_WEBHOOK_URL != '' }}" >> $GITHUB_OUTPUT
          echo "enable_discord=${{ secrets.DISCORD_WEBHOOK_URL != '' }}" >> $GITHUB_OUTPUT

  notify-on-failure:
    # security-analysis job이 실패했을 때만 실행
    if: ${{ failure() && (github.event_name == 'push' || github.event_name == 'pull_request') }}
    needs: [security-analysis, check-notification-status] # Add dependency on new job
    uses: ./.github/workflows/reusable-notify.yml
    with:
      status: "failure"
      enable_slack_notification: ${{ needs.check-notification-status.outputs.enable_slack }}
      enable_discord_notification: ${{ needs.check-notification-status.outputs.enable_discord }}
    secrets: inherit
